/*
 * jQuery gentleSelect plugin (version 0.1.4.1)
 * http://shawnchin.github.com/jquery-cron
 *
 * Modifed 2016 by Andreas Nordvall
 * https://github.com/Drakslaktarn/jquery-cron
 *
 * Copyright (c) 2010-2013 Shawn Chin.
 * Dual licensed under the MIT or GPL Version 2 licenses.
 *
 * Requires:
 * - jQuery
 *
 * Usage:
 *  (JS)
 *
 *  // initialise like this
 *  var c = $('#cron').cron({
 *    initial: '9 10 * * *', # Initial value. default = "* * * * *"
 *    url_set: '/set/', # POST expecting {"cron": "12 10 * * 6"}
 *  });
 *
 *  // you can update values later
 *  c.cron("value", "1 2 3 4 *");
 *
 * // you can also get the current value using the "value" option
 * alert(c.cron("value"));
 *
 *  (HTML)
 *  <div id='cron'></div>
 *
 * Notes:
 * At this stage, we only support a subset of possible cron options.
 * For example, each cron entry can only be digits or "*", no commas
 * to denote multiple entries. We also limit the allowed combinations:
 * - Every minute : * * * * *
 * - Every hour   : ? * * * *
 * - Every day    : ? ? * * *
 * - Every week   : ? ? * * ?
 * - Every month  : ? ? ? * *
 * - Every year   : ? ? ? ? *
 */(function(e){function m(e){return typeof e=="undefined"?!1:!0}function g(e){return!m(e)||typeof e=="object"}function y(t,n){if(m(n.customValues))for(key in n.customValues)if(t==n.customValues[key])return key;var r=/^((\d{1,2}|\*)\s){4}(\d{1,2}|\*)$/;if(typeof t!="string"||!r.test(t))return e.error("cron: invalid initial value"),undefined;var i=t.split(" "),s=[0,0,1,1,0],u=[59,23,31,12,6];for(var a=0;a<i.length;a++){if(i[a]=="*")continue;var f=parseInt(i[a]);if(m(f)&&f<=u[a]&&f>=s[a])continue;return e.error("cron: invalid value found (col "+(a+1)+") in "+o.initial),undefined}for(var l in v)if(v[l].test(t))return l;return e.error("cron: valid but unsupported cron format. sorry."),undefined}function b(t,n){if(!m(y(n.initial,n)))return!0;if(!g(n.customValues))return!0;if(m(n.customValues))for(key in n.customValues)if(v.hasOwnProperty(key))return e.error("cron: reserved keyword '"+key+"' should not be used as customValues key."),!0;return!1}function w(e){var t=e.data("block"),n=hour=day=month=dow="*",r=t.period.find("select").val();switch(r){case"minute":break;case"hour":n=t.mins.find("select").val();break;case"day":n=t.time.find("select.cron-time-min").val(),hour=t.time.find("select.cron-time-hour").val();break;case"week":n=t.time.find("select.cron-time-min").val(),hour=t.time.find("select.cron-time-hour").val(),dow=t.dow.find("select").val();break;case"month":n=t.time.find("select.cron-time-min").val(),hour=t.time.find("select.cron-time-hour").val(),day=t.dom.find("select").val();break;case"year":n=t.time.find("select.cron-time-min").val(),hour=t.time.find("select.cron-time-hour").val(),day=t.dom.find("select").val(),month=t.month.find("select").val();break;default:return r}return[n,hour,day,month,dow].join(" ")}var t={initial:"* * * * *",minuteOpts:{minWidth:100,itemWidth:30,columns:4,rows:undefined,title:"Minutes Past the Hour"},timeHourOpts:{minWidth:100,itemWidth:20,columns:2,rows:undefined,title:"Time: Hour"},domOpts:{minWidth:100,itemWidth:30,columns:undefined,rows:10,title:"Day of Month"},monthOpts:{minWidth:100,itemWidth:100,columns:2,rows:undefined,title:undefined},dowOpts:{minWidth:100,itemWidth:undefined,columns:undefined,rows:undefined,title:undefined},timeMinuteOpts:{minWidth:100,itemWidth:20,columns:4,rows:undefined,title:"Time: Minute"},effectOpts:{openSpeed:400,closeSpeed:400,openEffect:"slide",closeEffect:"slide",hideOnMouseOut:!0},url_set:undefined,customValues:undefined,onChange:undefined,useGentleSelect:!1,periods:["minute","hour","day","week","month","year"]},n="";for(var r=0;r<60;r++){var i=r<10?"0":"";n+="<option value='"+r+"'>"+i+r+"</option>\n"}var s="";for(var r=0;r<24;r++){var i=r<10?"0":"";s+="<option value='"+r+"'>"+i+r+"</option>\n"}var u="";for(var r=1;r<32;r++){if(r==1||r==21||r==31)var a="st";else if(r==2||r==22)var a="nd";else if(r==3||r==23)var a="rd";else var a="th";u+="<option value='"+r+"'>"+r+a+"</option>\n"}var f="",l=["January","February","March","April","May","June","July","August","September","October","November","December"];for(var r=0;r<l.length;r++)f+="<option value='"+(r+1)+"'>"+l[r]+"</option>\n";var c="",h=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];for(var r=0;r<h.length;r++)c+="<option value='"+r+"'>"+h[r]+"</option>\n";var p=["minute","hour","day","week","month","year"],d={minute:[],hour:["mins"],day:["time"],week:["dow","time"],month:["dom","time"],year:["dom","month","time"]},v={minute:/^(\*\s){4}\*$/,hour:/^\d{1,2}\s(\*\s){3}\*$/,day:/^(\d{1,2}\s){2}(\*\s){2}\*$/,week:/^(\d{1,2}\s){2}(\*\s){2}\d{1,2}$/,month:/^(\d{1,2}\s){3}\*\s\*$/,year:/^(\d{1,2}\s){4}\*$/},E={init:function(r){var i=r?r:{},o=e.extend([],t,i),a=e.extend({},t.effectOpts,i.effectOpts);e.extend(o,{minuteOpts:e.extend({},t.minuteOpts,a,i.minuteOpts),domOpts:e.extend({},t.domOpts,a,i.domOpts),monthOpts:e.extend({},t.monthOpts,a,i.monthOpts),dowOpts:e.extend({},t.dowOpts,a,i.dowOpts),timeHourOpts:e.extend({},t.timeHourOpts,a,i.timeHourOpts),timeMinuteOpts:e.extend({},t.timeMinuteOpts,a,i.timeMinuteOpts)});if(b(this,o))return this;var l=[],h="",d=o.customValues;if(m(d))for(var v in d)h+="<option value='"+d[v]+"'>"+v+"</option>\n";var g="",y=e.grep(o.periods,function(t){return e.inArray(t,p)!==-1});for(var w=0;w<y.length;w++)g+="<option value='"+y[w]+"'>"+y[w]+"</option>\n";l.period=e("<span class='cron-period'>Every <select name='cron-period'>"+h+g+"</select> </span>").appendTo(this).data("root",this);var x=l.period.find("select");return x.bind("change.cron",S.periodChanged).data("root",this),o.useGentleSelect&&x.gentleSelect(a),l.dom=e("<span class='cron-block cron-block-dom'> on the <select name='cron-dom'>"+u+"</select> </span>").appendTo(this).data("root",this),x=l.dom.find("select").data("root",this),o.useGentleSelect&&x.gentleSelect(o.domOpts),l.month=e("<span class='cron-block cron-block-month'> of <select name='cron-month'>"+f+"</select> </span>").appendTo(this).data("root",this),x=l.month.find("select").data("root",this),o.useGentleSelect&&x.gentleSelect(o.monthOpts),l.mins=e("<span class='cron-block cron-block-mins'> at <select name='cron-mins'>"+n+"</select> minutes past the hour </span>").appendTo(this).data("root",this),x=l.mins.find("select").data("root",this),o.useGentleSelect&&x.gentleSelect(o.minuteOpts),l.dow=e("<span class='cron-block cron-block-dow'> on <select name='cron-dow'>"+c+"</select> </span>").appendTo(this).data("root",this),x=l.dow.find("select").data("root",this),o.useGentleSelect&&x.gentleSelect(o.dowOpts),l.time=e("<span class='cron-block cron-block-time'> at <select name='cron-time-hour' class='cron-time-hour'>"+s+"</select>:<select name='cron-time-min' class='cron-time-min'>"+n+" </span>").appendTo(this).data("root",this),x=l.time.find("select.cron-time-hour").data("root",this),o.useGentleSelect&&x.gentleSelect(o.timeHourOpts),x=l.time.find("select.cron-time-min").data("root",this),o.useGentleSelect&&x.gentleSelect(o.timeMinuteOpts),l.controls=e("<span class='cron-controls'>&laquo; save <span class='cron-button cron-button-save'></span> </span>").appendTo(this).data("root",this).find("span.cron-button-save").bind("click.cron",S.saveClicked).data("root",this).end(),this.find("select").bind("change.cron-callback",S.somethingChanged),this.data("options",o).data("block",l),this.data("current_value",o.initial),E.value.call(this,o.initial)},value:function(e){if(!e)return w(this);var t=this.data("options"),n=this.data("block"),r=t.useGentleSelect,i=y(e,t);if(!m(i))return!1;if(m(t.customValues)&&t.customValues.hasOwnProperty(i))i=t.customValues[i];else{var s=e.split(" "),o={mins:s[0],hour:s[1],dom:s[2],month:s[3],dow:s[4]},u=d[i];for(var a=0;a<u.length;a++){var f=u[a];if(f=="time"){var l=n[f].find("select.cron-time-hour").val(o.hour);r&&l.gentleSelect("update"),l=n[f].find("select.cron-time-min").val(o.mins),r&&l.gentleSelect("update")}else{var l=n[f].find("select").val(o[f]);r&&l.gentleSelect("update")}}}var c=n.period.find("select").val(i);return r&&c.gentleSelect("update"),c.trigger("change"),this}},S={periodChanged:function(){var t=e(this).data("root"),n=t.data("block"),r=t.data("options"),i=e(this).val();t.find("span.cron-block").hide();if(d.hasOwnProperty(i)){var s=d[e(this).val()];for(var o=0;o<s.length;o++)n[s[o]].show()}},somethingChanged:function(){root=e(this).data("root"),m(root.data("options").url_set)?E.value.call(root)!=root.data("current_value")?(root.addClass("cron-changed"),root.data("block").controls.fadeIn()):(root.removeClass("cron-changed"),root.data("block").controls.fadeOut()):root.data("block").controls.hide();var t=root.data("options").onChange;m(t)&&e.isFunction(t)&&t.call(root)},saveClicked:function(){var t=e(this),n=t.data("root"),r=E.value.call(n);if(t.hasClass("cron-loading"))return;t.addClass("cron-loading"),e.ajax({type:"POST",url:n.data("options").url_set,data:{cron:r},success:function(){n.data("current_value",r),t.removeClass("cron-loading"),r==E.value.call(n)&&(n.removeClass("cron-changed"),n.data("block").controls.fadeOut())},error:function(){alert("An error occured when submitting your request. Try again?"),t.removeClass("cron-loading")}})}};e.fn.cron=function(t){if(E[t])return E[t].apply(this,Array.prototype.slice.call(arguments,1));if(typeof t=="object"||!t)return E.init.apply(this,arguments);e.error("Method "+t+" does not exist on jQuery.cron")}})(jQuery);